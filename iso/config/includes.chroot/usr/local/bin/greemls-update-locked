#!/usr/bin/env bash
set -euo pipefail

# Firewall allowlist mode for safe updates
RULES=$(mktemp)
trap 'rm -f "$RULES"' EXIT

cat > "$RULES" <<'NFT'
flush ruleset

define good_dns = {1.1.1.1, 8.8.8.8}
define good_http = {104.16.0.0/12, 151.101.0.0/16}

table inet filter {
  sets {
    dns_servers { type ipv4_addr; flags interval; elements = $good_dns; }
    http_ranges { type ipv4_addr; flags interval; elements = $good_http; }
  }
  chains {
    input {
      type filter hook input priority 0; policy drop;
      ct state established,related accept
      iif lo accept
    }
    forward { type filter hook forward priority 0; policy drop; }
    output {
      type filter hook output priority 0; policy drop;
      ct state established,related accept
      oif lo accept
      udp dport 53 ip daddr @dns_servers accept
      tcp dport {80,443} ip daddr @http_ranges accept
    }
  }
}
NFT

echo "[+] Activando firewall de allowlist (nftables)"
sudo nft -f "$RULES"

echo "[+] Actualizando firmas ClamAV"
sudo freshclam || true

echo "[+] Ejecutando rkhunter --update"
sudo rkhunter --update || true

echo "[+] Restaurando polÃ­tica por defecto (permitir)"
sudo nft flush ruleset || true

echo "[+] Done"


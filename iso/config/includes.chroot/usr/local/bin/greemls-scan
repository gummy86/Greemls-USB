#!/usr/bin/env bash
set -euo pipefail

LOG_DIR="/var/log/greemls"
mkdir -p "$LOG_DIR"
TS=$(date -Iseconds)
OUT_JSON="$LOG_DIR/scan_${TS}.json"
OUT_HTML="$LOG_DIR/scan_${TS}.html"

echo "[+] GREEMLS scan started $TS" >&2

# Ensure mounts are read-only by default
mount | grep -E ' /(mnt|media)/' >/dev/null 2>&1 || true

# Update definitions if network is available
if ping -c1 -W1 1.1.1.1 >/dev/null 2>&1; then
  freshclam || true
fi

TMPDIR=$(mktemp -d)
trap 'rm -rf "$TMPDIR"' EXIT

RESULT_JSON=$(cat <<'JSON'
{
  "generated": "__TS__",
  "engine": {
    "clamav": "enabled",
    "rkhunter": "enabled",
    "chkrootkit": "enabled",
    "yara": "enabled"
  },
  "events": []
}
JSON
)

# Run rkhunter
if command -v rkhunter >/dev/null 2>&1; then
  rkhunter --update || true
  rkhunter --check --sk --nocolors > "$TMPDIR/rkhunter.txt" 2>&1 || true
fi

# Run chkrootkit
if command -v chkrootkit >/dev/null 2>&1; then
  chkrootkit > "$TMPDIR/chkrootkit.txt" 2>&1 || true
fi

# Run ClamAV quick scan on mounted volumes
if command -v clamscan >/dev/null 2>&1; then
  clamscan -r --infected --copy="$TMPDIR/quarantine" /media /mnt 2>/dev/null | tee "$TMPDIR/clamav.txt" || true
fi

# Aggregate basic findings
python3 - "$TMPDIR" "$OUT_JSON" <<'PY'
import json, os, sys, datetime, re
tmp, out = sys.argv[1], sys.argv[2]
events = []
def add_event(source, severity, description, details=None):
    events.append({
        "id": str(len(events)+1),
        "timestamp": datetime.datetime.utcnow().isoformat()+"Z",
        "type": "scan",
        "severity": severity,
        "source": source,
        "description": description,
        "details": details or {},
        "evidence": []
    })

# rkhunter
rk = os.path.join(tmp, 'rkhunter.txt')
if os.path.exists(rk):
    with open(rk, 'r', errors='ignore') as f:
        text = f.read()
    sus = [line for line in text.splitlines() if 'Warning' in line or 'Rootkit' in line]
    if sus:
        add_event('rkhunter', 'high', f'Posibles hallazgos: {len(sus)}', {"lines": min(30, len(sus))})

# chkrootkit
ck = os.path.join(tmp, 'chkrootkit.txt')
if os.path.exists(ck):
    with open(ck, 'r', errors='ignore') as f:
        text = f.read()
    if 'INFECTED' in text or 'suspicious' in text.lower():
        add_event('chkrootkit', 'high', 'Indicadores sospechosos en chkrootkit')

# clamav
cl = os.path.join(tmp, 'clamav.txt')
if os.path.exists(cl):
    with open(cl, 'r', errors='ignore') as f:
        for line in f:
            if line.strip().endswith('FOUND'):
                path = line.split(':',1)[0]
                add_event('clamav', 'critical', 'Malware detectado', {"location": path})

doc = {
  "generated": datetime.datetime.utcnow().isoformat()+"Z",
  "engine": {"clamav":"enabled","rkhunter":"enabled","chkrootkit":"enabled","yara":"enabled"},
  "events": events
}
with open(out, 'w') as f:
    json.dump(doc, f, indent=2)
print(out)
PY

cp "$OUT_JSON" "$OUT_HTML" 2>/dev/null || true
echo "[+] Reporte JSON: $OUT_JSON"
echo "[+] GREEMLS scan finished" >&2

